# test equivalence of gap-segment derivatives to derivative followed by rectangular smoothing

Y = c(0,0,0,0,0,0.105,0.249,0.77,0.91,1,1,0.97,1,1,1,0.89,0.76,0.245,0.101,0.05,0,0.01,0,0,0)
x = 1:25

Y2 = c(0,0,0,0,0,0,0.02,0.1,0.4,0.12,0.05,0,0,0,0,0)
x2 = 1:16

Y3 = c(3.830658101833251e-07, 1.5421560917161514e-08, 5.027652960620799e-09, 1.296231899594602e-09, 1.9683539242976167e-09, 4.4055181724900194e-09, 7.180656957928022e-09, 1.1550743472810154e-08, 1.0882196477268735e-08, 1.065534789290723e-07, 1.2712728647557014e-08, 2.916189600910002e-08, 3.045237235710374e-07, 6.84928593841505e-08, 1.0228177194093746e-09, 5.171291173056147e-10, 4.047990831423931e-10, 3.6531233593706247e-10, 9.829552727325108e-10, 1.4026499961516947e-08, 4.191667244413111e-07, 2.940790909633506e-05, 0.02146167680621147, 0.26972922682762146, 0.597173810005188, 0.9444661736488342, 0.9098055958747864, 0.9004780054092407, 0.7953069806098938, 0.8826730847358704, 0.8664788007736206, 0.9516551494598389, 0.9888522624969482, 0.9365819096565247, 0.4866682291030884, 0.11737522482872009, 0.010544626973569393, 0.0033083949238061905, 0.002624192740768194, 0.0007528587593697011, 0.0001653672952670604, 1.935380896611605e-05, 5.304135356709594e-06, 3.5304387893120293e-06, 1.9548519247791774e-08, 2.054572156851009e-08, 1.0690661689238823e-08, 1.8462403161834118e-08, 2.470839888246701e-07, 1.206837936251759e-07, 1.0354912660659465e-07, 4.22175929770674e-08, 3.2910703051669543e-09, 9.582585835943291e-10, 1.3504954932130886e-09, 2.281949074145473e-10, 7.807783308777516e-10, 8.561358566527844e-11)
x3 = 1:58

Y4 = c(2.0530130768747767e-06, 2.4136659249052173e-06, 3.907186680862651e-07, 8.579528198993103e-09, 2.7936752644563967e-07, 3.3567509660770156e-08, 1.7163834797884192e-07, 6.143572761629912e-08, 2.979012814208204e-09, 7.945083524418806e-08, 3.885031851780241e-09, 1.1384400089298197e-09, 5.118533721870655e-11, 5.29947086214122e-10, 1.0225250646200834e-09, 9.327922434465563e-09, 1.23719401390332e-09, 3.0322849786657e-10, 9.148429569449945e-09, 1.2417692651922607e-08, 2.445751852064859e-05, 0.0001169177849078551, 0.0017858443316072226, 0.014302704483270645, 0.02180597558617592, 0.03600050508975983, 0.10874700546264648, 0.2214251309633255, 0.23954972624778748, 0.6150153279304504, 0.475263386964798, 0.352787584066391, 0.5489389300346375, 0.5325940847396851, 0.17277197539806366, 0.48728153109550476, 0.48313215374946594, 0.7684732675552368, 0.654664933681488, 0.6407176852226257, 0.4201093912124634, 0.03546454384922981, 0.011162719689309597, 0.019689740613102913, 0.013155857101082802, 0.0027204782236367464, 7.504247332690284e-05, 2.3669368601986207e-05, 9.771202712727245e-06, 6.25131315246108e-06, 3.998476586275501e-06, 1.7135178040916799e-06, 3.808088777645935e-08, 6.955382048090542e-08, 4.5085126743060755e-09, 9.859244087806474e-09, 4.940340581072178e-09, 1.090491585920006e-10, 8.337234375099811e-11, 1.3504103391070998e-09, 1.0346394851978857e-09, 2.0728736782604784e-10, 1.3890474326316848e-09, 3.463026310157602e-09)
x4 = 1:64

Y5 = c(2.7395965704335445e-11, 3.1431145880445044e-11, 4.482345484363437e-12, 1.536302682292323e-11, 1.164128099473416e-10, 7.858202977217843e-11, 4.219090909973744e-10, 2.557739298136852e-10, 2.8284444231196915e-10, 2.3747898092452147e-10, 6.0088134468117005e-09, 6.154280640657817e-08, 1.1502503127758246e-07, 3.268513992793487e-08, 1.1361001028831197e-08, 4.825945509878693e-08, 8.709537979711968e-08, 9.098340569835273e-07, 1.3775481875200057e-06, 1.4248726074583828e-06, 1.524542039987864e-05, 0.0001206173183163628, 0.0030818721279501915, 0.0018320470117032528, 0.10356663912534714, 0.6399807333946228, 0.8891167044639587, 0.9757230281829834, 0.9913124442100525, 0.9436256885528564, 0.7955455780029297, 0.337372362613678, 0.12663790583610535, 0.012075523845851421, 0.00045258778845891356, 0.0001392036210745573, 3.73900038539432e-05, 1.735933437885251e-05, 7.448230462614447e-06, 7.239547272774871e-08, 6.810598612849716e-11, 2.7458585752371256e-11, 1.723678838549958e-10, 1.1471829042264403e-09, 2.2749624406515068e-09, 5.093072186213021e-09, 9.692001157191044e-08, 2.035568336111737e-08, 1.33160024673451e-10, 7.866016171753643e-11, 2.456162773167847e-10, 5.224450316809737e-10, 5.04829333891621e-09, 9.325841432428206e-09, 1.3944289278811084e-08, 1.2735559273835406e-09)
x5 = 1:56

# pred_fragments/af_eval/fn000280_1_83.561_84.041.wav
Y6 = c(3.1372499051940395e-06, 2.684828359633684e-07, 1.3459221293032897e-07, 9.761721742052032e-08, 3.558387220436998e-07, 5.22134726566037e-08, 3.76288866732466e-09, 6.210572944809201e-09, 1.9564634357038813e-08, 1.6889204701442395e-08, 9.686305091349823e-09, 1.2671090843241473e-08, 7.296787174482233e-08, 4.4248326958040707e-07, 3.280682676631841e-07, 1.3812517352107534e-08, 2.238173202329108e-08, 2.0325646232777217e-07, 1.3153075997252017e-06, 9.34275594772771e-05, 0.0004779696464538574, 0.0008704662322998047, 0.02913886308670044, 0.1819693148136139, 0.1853586733341217, 0.12937480211257935, 0.3174807131290436, 0.6536169052124023, 0.6326614618301392, 0.7834174633026123, 0.6926925182342529, 0.5041743516921997, 0.26237744092941284, 0.14202964305877686, 0.042226940393447876, 0.007893085479736328, 0.0005150437355041504, 0.00013783574104309082, 8.715011063031852e-05, 4.7654051741119474e-05, 3.6177723814034835e-05, 7.017205462034326e-06, 3.899761509273958e-07, 3.216926188542857e-06, 5.674901785823749e-06, 4.6445893531199545e-07, 6.543826884808368e-07, 2.1159206653464935e-07, 1.0321565468984772e-06, 3.4419907024130225e-05, 1.5985873687895946e-05, 9.831746865529567e-06, 1.8142669432563707e-05, 2.215681888628751e-05, 8.407626592088491e-05, 0.00015735626220703125, 6.236635090317577e-05, 4.023849032819271e-05, 2.6481620807317086e-05, 1.6552867236896418e-05, 5.839317509526154e-06, 5.459030035126489e-06)

# pred_fragments/af_eval/fn000296_1_755.526_756.006.wav
Y7 = c(0.990759015083313, 0.9405138492584229, 0.8064591884613037, 0.04810374975204468, 0.0012070238590240479, 0.0008176565170288086, 0.0006163120269775391, 0.00018906593322753906, 0.0002048015594482422, 8.321832865476608e-05, 9.71158588072285e-05, 3.4227006835862994e-05, 0.00042885541915893555, 9.272181341657415e-05, 0.0018639862537384033, 0.0003173649311065674, 0.0001475512981414795, 0.0001932382583618164, 0.0008611381053924561, 0.007761716842651367, 0.012721925973892212, 0.08312839269638062, 0.074872225522995, 0.13394489884376526, 0.28073179721832275, 0.22801482677459717, 0.37737590074539185, 0.7168768048286438, 0.7885489463806152, 0.8484736680984497, 0.07704553008079529, 0.03282254934310913, 0.006255149841308594, 0.0010630488395690918, 0.0010085105895996094, 0.01494443416595459, 0.03350043296813965, 0.021583586931228638, 0.012528538703918457, 0.002189427614212036, 0.0010109543800354004, 0.0004069209098815918, 0.0003368258476257324, 0.00016012787818908691, 0.0006131529808044434, 0.005152344703674316, 0.013508886098861694, 0.024737805128097534, 0.006982594728469849, 0.0018300414085388184, 0.005678236484527588, 0.0020386576652526855, 0.00405922532081604, 0.005975484848022461, 0.00678214430809021, 0.0025801658630371094, 0.0003826618194580078, 5.590649016085081e-05, 4.0754530346021056e-05, 2.7439220502856188e-05, 8.96152196219191e-05, 0.00045174360275268555)

# pred_fragments/af_eval_s/fn008117_1_144.566_144.996.wav
Y8 = c(4.2253624210619734e-11, 2.1292937031625048e-12, 6.1883805371754086e-12, 7.161828768920131e-11, 3.328112008205153e-09, 2.9003322765674966e-07, 2.5186079710692866e-07, 1.780168616960509e-07, 8.650930283238267e-08, 6.582665150745015e-07, 1.4296713288786123e-06, 1.9219598470954224e-05, 2.8466040021157824e-05, 0.0004063248634338379, 0.0048389732837677, 0.0031549930572509766, 0.0008272826671600342, 0.004153072834014893, 0.005220204591751099, 0.007673025131225586, 0.005209505558013916, 0.0016186833381652832, 0.00014790892601013184, 0.000423431396484375, 0.0002422332763671875, 2.2689306206302717e-05, 2.9126432821158232e-08, 2.2274729283289219e-10, 8.936488159715095e-13, 1.1003788754748028e-13, 3.0454087060309554e-13, 1.6702500927473496e-12, 5.951133683068655e-13, 1.6573501468788998e-12, 9.30957893240103e-13, 2.682359373409448e-14, 5.38853629685615e-13, 2.228147354121912e-11, 2.1516868148330204e-12, 6.678611656762978e-12, 4.3071284386297926e-12, 1.7328222190471365e-11, 5.410093380231462e-12, 3.3420505946013535e-12, 4.246927115536536e-11, 2.1336772626501244e-11, 1.968733986598692e-12, 1.6893214604962736e-10, 2.0618956542151068e-10, 6.117795159354955e-10, 3.5915117546636566e-09, 1.8791347144997417e-08)

smooth = function(yy, ww){
  xx = 1:length(yy)
  x_offset = (ww - 1) / 2
  yy_smooth = c()
  for (xi in xx){
    if (xi > x_offset && xi <= (length(xx) - x_offset)){
      yy_smooth = c(yy_smooth, sum(yy[(xi-x_offset):(xi+x_offset)]) / ww)
    } else {
      yy_smooth = c(yy_smooth, yy[xi])
    }
  }
  return(yy_smooth)
}

diff1 = function(yy){
  xx = 1:length(yy)
  yy_d = c()
  for (xi in xx){
    if (xi > 1 && xi < length(xx)) {
      yy_d = c(yy_d, yy[xi+1] - yy[xi-1])
    } else {
      yy_d = c(yy_d, 0)
    }
  }
  return(yy_d)
}

diff2 = function(yy){
  xx = 1:length(yy)
  yy_dd = c()
  for (xi in xx){
    if (xi > 1 && xi < length(xx)) {
      yy_dd = c(yy_dd, yy[xi+1] - 2*yy[xi] + yy[xi-1])
    } else {
      yy_dd = c(yy_dd, 0)
    }
  }
  return(yy_dd)
}

diff3 = function(yy){
  xx = 1:length(yy)
  yy_ddd = c()
  for (xi in xx){
    if (xi > 2 && xi < (length(xx) - 1)) {
      yy_ddd = c(yy_ddd, yy[xi+2] - 2*yy[xi+1] + 2*yy[xi-1] - yy[xi-2])
    } else {
      yy_ddd = c(yy_ddd, 0)
    }
  }
  return(yy_ddd)
}


plot(x, Y, type = "b")
plot(x, smooth(smooth(diff2(Y), 3),3), type = "b")
plot(x, smooth(smooth(smooth(diff3(Y), 3),3),3), type = "b")

plot(x2, Y2, type = "b")
plot(x2, smooth(smooth(diff2(Y2), 3),3), type = "b")
plot(x2, smooth(smooth(smooth(diff3(Y2), 3),3),3), type = "b")





Ydd_gs = c()
for (xi in x){
  if (xi > 3 && xi < 23) {
    Ydd_gs = c(Ydd_gs, Y[xi+3] - 2*Y[xi] + Y[xi-3])
  } else {
    Ydd_gs = c(Ydd_gs, 0)
  }
}

plot(1:length(Ydd_gs), Ydd_gs, type = "b")
plot(1:length(Y), smooth(smooth(diff2(Y), 3), 3), type = "b")

Yddd = c()
for (xi in x){
  if (xi > 2 && xi < 24) {
    Yddd = c(Yddd, Y[xi+2] - 2*Y[xi+1] + 2*Y[xi-1] - Y[xi-2])
  } else {
    Yddd = c(Yddd, 0)
  }
}

# 2 smooths might be too much to get stable part of Y5
plot(x5, smooth(smooth(diff2(Y5),3),3), type = "b")


# why not sqrt the signal?
plot(x4, Y4, type = "b")
plot(x4, sqrt(Y4), type = "b")

# diff2 distinguishes better between a second start vs. actual peak; plus we have less noise
plot(1:length(Y6), smooth(smooth(smooth(diff3(sqrt(Y6)),3),3),3), type = "b")
plot(1:length(Y6), smooth(smooth(smooth(diff2(sqrt(Y6)),3),3),3), type = "b")

# using diff2, we would have to establish separate min and max thresholds
# grid search will have to show whether sqrt should be used, but it seems to work quite well in emphasizing change from near zero
# grid search will have to show how many smooths are best

# again sqrt is better at identifying the 'slow' start of the peak
plot(1:length(Y7), diff2(smooth(smooth(smooth(sqrt(Y7),3),3),3)), type = "b")
plot(1:length(Y7), diff2(smooth(smooth(smooth(Y7,3),3),3)), type = "b")



plot(1:length(Y8), diff2(smooth(smooth(Y8,3),3)), type = "b")


par(mfrow = c(3,1))
plot(1:length(Y3), Y3, type = "b", xlim = c(15,45))
plot(1:length(Y3), smooth(smooth(Y3,3),3), type = "b", xlim = c(15,45))
plot(1:length(Y3), diff2(smooth(smooth(Y3,3),3)), type = "b", xlim = c(15,45))
abline(h=0.05, lty="dashed")
abline(h=-0.05, lty="dashed")

